<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IceGate eCopy Search</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    #spin {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    #message {
        margin-left: 5px;
        font-weight: 500;
    }

    .custom-spinner {
        border-width: 3px;
        border-color: currentColor transparent transparent transparent;
        border-radius: 50%;
        animation: spin 1.2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
</style>
<body>
    <div class="container mt-5">
        <h2>IceGate eCopy Search</h2>
        <form id="ecopyForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" class="form-control" id="username" placeholder="Enter Username" required autocomplete="current-password">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Enter Password" required autocomplete="current-password">
            </div>
            <div class="form-group">
                <label for="noOfDays">Number of Days</label>
                <input type="number" class="form-control" id="noOfDays" placeholder="Enter Number of Days" required>
            </div>
            <div class="form-group">
                <label for="noOfRows">Number of Rows</label>
                <input type="number" class="form-control" id="noOfRows" placeholder="Enter Number of Rows" required>
            </div>
            <div class="form-group">
                <label for="option">Option</label>
                <select class="form-control" id="option" required>
                    <option value="1">Shipping Bill / SB</option>
                    <option value="2">Let Export Order / LEO</option>
                    <option value="3">Gatepass for Let Export Order / LEO</option>
                    <option value="4">Bill of Entry / BoE</option>
                    <option value="5">Out of Charge / OOC</option>
                    <option value="6">Gatepass for Out of Charge / OOC</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
        <div class="mt-4" id="result">
            <div id="spin" style="display: none;">
                <div class="spinner-border text-primary custom-spinner" style="width: 20px; height: 20px; border: 3px dashed;"></div>
                <div id="message" class="text-primary">logging...</div>
            </div>
        </div>
    </div>

    <script>
        function getFileNameFromPath(filePath) {
            return filePath.replace(/.*[\/\\]/, '');
        }
        document.getElementById('ecopyForm').addEventListener('submit', function(event) {
            event.preventDefault();

            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;
            let noOfDays = document.getElementById('noOfDays').value;
            let noOfRows = document.getElementById('noOfRows').value;
            let option = document.getElementById('option').value;
            let spinner = document.getElementById('spin');
            let optionElement = document.getElementById('option');
            let selectedText = optionElement.options[optionElement.selectedIndex].text;
            
            let data = {
                username: username,
                password: password,
                noOfDays: noOfDays,
                noOfRows: noOfRows,
                url: "C:\\Python\\ICEGATE_AUTOMATION\\downloads",
                option: option
            };
            
            let statusMessages = [
                                    "Initializing...",
                                    "Gathering data...",
                                    "Verifying details...",
                                    "logged in...",
                                    "download e-copy founded...",
                                    selectedText+" button is founded...",
                                    selectedText+" button is clicked...", 
                                    "Please wait...",
                                    "Loading resources...",
                                    "Finalizing...",
                                    "Fetching information...",
                                    "Just a moment...",
                                    "Optimizing process...",
                                    "Preparing results...",
                                    "almost done..."
                                ];
            let messageIndex = 0;

            spinner.style.display = "flex";

            let messageInterval = setInterval(function() {
                spinner.children[1].innerText = statusMessages[messageIndex];
                messageIndex = (messageIndex + 1) % statusMessages.length;
            }, 5000);

            fetch('/api/icegate/ecopy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.status);
                clearInterval(messageInterval); 
                spinner.style.display = "none";
                let resultDiv = document.getElementById('result');
                if (data.status === "warning") {
                    resultDiv.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
                }
                else if (data.length > 0) {
                    let table = '<table class="table table-bordered">';
                    table += '<thead><tr>';
                    table += '<th>Job No</th>';
                    table += '<th>Job Date</th>';
                    table += '<th>SB No</th>';
                    table += '<th>SB Date</th>';
                    table += '<th>Custom Location</th>';
                    table += '<th>Ack File</th>';
                    table += '<th>Signed Copy</th>';
                    table += '</tr></thead><tbody>';

                    data.forEach(function(item) {
                        console.log(getFileNameFromPath(item.ack_file));
                        table += '<tr>';
                        table += `<td>${item.jobNo}</td>`;
                        table += `<td>${item.jobDate}</td>`;
                        table += `<td>${item.sbNo}</td>`;
                        table += `<td>${item.sbDate}</td>`;
                        table += `<td>${item.customLocation}</td>`;
                        table += `<td><a href="/downloads/${getFileNameFromPath(item.ack_file)}" target="_blank">Download Ack File</a></td>`;
                        table += `<td>${item.signed_copy.includes("C:\\") ? '<a href="/downloads/' + getFileNameFromPath(item.signed_copy) + '" target="_blank">Open Signed Copy</a>' : item.signed_copy}</td>`;
                        table += '</tr>';
                    });

                    table += '</tbody></table>';
                    resultDiv.innerHTML = table;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
                }
            })
            .catch(error => {
                clearInterval(messageInterval);
                spinner.style.display = "none";

                console.error('Error:', error);
                let resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `<div class="alert alert-danger">An error occurred: ${error}</div>`;
            });
        });
    </script>
</body>
</html>
